# Example deployment of Relaynet Pong to Google Cloud Platform

This directory contains a Terraform module to deploy Relaynet Pong and its backing services (Redis and Vault) to a production-ready environment on GCP.

Note that the primary objective here is to provide a working environment for this service, which can be used as an starting point for a real-world deployment where you may want to re-use any pre-existing Redis or Vault instances. Consequently, Relaynet Pong itself is configured with values that are safe in production, but you should check the corresponding documentation for the backing services to learn how to configure them in production.

Apart from the Kubernetes and GCP resources created by the chart, this Terraform module will create the following GCP resources:

- A GKE cluster.
- A corresponding GCP node pool.
- A GCP-managed Redis instance (aka Memorystore for Redis).
- A GCP HTTP load balancer (managed by a Kubernetes ingress).

## Pre-requisites

1. Install the following dependencies: Git, Terraform, Helm 3, `kubectl` and the `gcloud` CLI.
1. Set your GCP credentials in a location supported by the GCP provider in Terraform, if you haven't already done so; for example:
  ```
   gcloud auth application-default login
  ```
1. Create the GCP project where you want to host the resources created by this module, unless you want to reuse an existing project.
1. Go to your project's [API library](https://console.cloud.google.com/apis/library/container.googleapis.com) and make sure the following APIs are enabled: Kubernetes and Google Cloud Memorystore for Redis.
1. Check out this directory if you haven't done so:
   ```
   git clone https://github.com/relaycorp/relaynet-pong-chart.git
   cd relaynet-pong-chart/example
   ```

## Install

We'll create the GCP resources first so we can then create the Kubernetes resources in the newly-created cluster.

To create the GCP resources, run:

```
terraform init
terraform apply
```

The commands above require about 10 minutes to complete. Once the GCP resources are available, it's time to create the Kubernetes resources. First, download the credentials for the newly-created cluster; e.g.:

```
gcloud container clusters get-credentials relaynet-pong \
    --zone us-central1-a \
    --project $GCP_PROJECT
```

Then install Vault in development mode:

1. Deploy Vault using the official Helm chart:
   ```
   helm install vault https://github.com/hashicorp/vault-helm/archive/v0.3.3.tar.gz
   ```
1. Initialize Vault and securely store tokens generated. Keep the tokens handy because we'll need them shortly.
   ```
   kubectl exec -it vault-0 -- vault operator init
   ```
1. Temporarily store the root token generated by `vault operator init` as we'll use it later a few times. Note that you should minimize the use of this token in production and use non-root authentication instead.
   ```
   VAULT_TOKEN='replace with root token'
   ```
1. Unseal Vault by running the following command three times, entering a different unseal token each time:
   ```
   kubectl exec -it vault-0 -- vault operator unseal
   ```
1. Enable the kv secret store at `pong-keys/` and make such secrets expire after 7 days:
   ```
   kubectl exec -it vault-0 -- vault login token=${VAULT_TOKEN}
   kubectl exec -it vault-0 -- vault secrets enable -path=pong-keys kv-v2
   ```

Finally, deploy the Relaynet Pong chart:

1. Install the Relaynet Pong chart with an HTTP load balancer (done by `ingress.enabled=true`):
   ```
   helm install \
     --set ingress.enabled=true \
     --set "redis.host=$(terraform output redis_host)" \
     --set vault.host=vault.default.svc.cluster.local \
     --set vault.token=$VAULT_TOKEN \
     relaynet-pong \
     https://github.com/relaycorp/relaynet-pong-chart/archive/master.tar.gz
   ```
1. Follow the post-install instructions to generate the initial key pairs.

## Cleanup

To destroy the GCP and Kubernetes resources created here, run:

```
helm uninstall relaynet-pong
helm uninstall vault
terraform destroy
```

You may also want to remove dangling references to the cluster in your local `kubectl` configuration:

```
kubectl config unset users.gke_relaynet-pong-example_us-central1-a_relaynet-pong
kubectl config delete-context gke_relaynet-pong-example_us-central1-a_relaynet-pong
kubectl config delete-cluster gke_relaynet-pong-example_us-central1-a_relaynet-pong
```
